# シェルスクリプトの基本

国立遺伝学研究所　坂本美佳

## 0. シェルスクリプトとは

[Wikipedia](https://ja.wikipedia.org/wiki/シェルスクリプト)をみると、
> シェルスクリプト (英語: shell script) は、オペレーティングシステムのシェルまたはコマンドラインインタプリタ向けに書かれたスクリプト言語である。

とあります。これだけではなんのことかさっぱりわかりませんね。ざっくりですが、Macではターミナル、WindowsではTeraTermなどの端末アプリケーションで使えるコマンドをつなげて使うもの、と覚えておけばよいでしょう。PythonとかPerlといったプログラミング言語を使わなくても、シェルスクリプトだけで簡単な処理を行うことができます。また、バイオインフォマティクスでは、複数のCLIアプリケーションを連続して使う処理（パイプライン）をシェルスクリプトにまとめて実行することが多いでしょう。

シェルには歴史的にさまざまな種類がありますが、この講義では**bash**を使います。Macの最新OS(10.15 Catalina)では**zsh**が採用されています。bashとzshで細かな点に違いはありますが、この講義で使う基本的なシェルスクリプトの文法はほぼ同じです。

この講義では、シェルスクリプトを書く上で必要最低限の用語や文法を紹介しながら、簡単なシェルスクリプトを書いて実行するまでを説明しています。ここで説明しきれなかったことや、もっと詳しい内容を知りたい場合は、以下の参考図書をご覧ください。

**参考図書**

- シェルプログラミング実用テクニック　上田隆一（著）USP研究所（監修）技術評論社
- ソフトウェアデザイン　2017年1月号「特集・シェル30本ノック」P.17-61　技術評論社

## 1. 変数

ある文字列に、別の文字列を代入して使うことができます。`$`をつけると代入された文字列を呼び出すことができます。`=`の前後には**スペースを入れないで**ください。

```{bash}
FRUITS=mikan
echo $FRUITS
```

複数の文字列を代入することもできます。

```{bash}
FRUITS="mikan ringo budou"
echo $FRUITS
```

コマンドを実行した結果を変数に入れることもできます。`kudamono.txt`の内容を`cat`コマンドで見てみましょう。

```{bash}
cat kudamono.txt
```

以下のように表示されるはずです。

```{bash}
orange
apple
grape
```

では、`kudamono.txt`の内容を変数`FRUITS`に代入してみましょう。コマンドを`$()`の中にいれて`$(コマンド)`とするか、バッククオート` `` `で囲みます。

```{bash}
FRUITS=$(cat kudamono.txt)
echo $FRUITS
```

## 2. for文

`for ~ do ~ done`を使うと繰り返し処理ができます。

以下をお使いのエディタにコピペして、`fruits.bash`という名前で保存します。

1行目の`#!/bin/bash` はshebang（読み方はシバンとかシェバンとか）と呼び、スクリプトのインタプリタを指定しています。

```{bash}
#!/bin/bash

FRUITS="mikan ringo budou"

for DESSERT in $FRUITS
do
  echo $DESSERT
done
```

`ls -l`でファイルのパーミッションを確認しておきます。

```{bash}
-rw-r--r--   1 user  group       89  2 18 10:33 fruits.bash
```

x(実行可能)がついていないので実行権限をつけます。`chmod`はファイルのパーミッションを設定するコマンドで、

- r:読み取り可(4)
- w:書き込み可(2)
- x:実行可(1)

r,w,xまたは()内の数字の加算値で設定します。コマンドの後の数字は「ファイルの所有者、グループ、その他」の順です。以下の例では、所有者が「読み取り、書き込み、実行可」、グループのメンバーは「読み取りと実行可」、その他は「いずれも不可」という設定です。共有のサーバにシェルスクリプトを置いておくときは、750にしておくと安心でしょう。

```{bash}
chmod 750 fruits.bash
```

`chmod 750`のかわりに`chmod +x`でも良いですが、これでは「その他」も実行できてしまうので、所有者だけが実行できるようにする場合は`chmod u+x`とします。

これで実行できるようになりました。

```{bash}
./fruits.bash
```

`mikan ringo budou`が１行ずつ出力されるはずです。

```{bash}
mikan
ringo
budou
```

なお、実行権限をつけなくても、実行時にインタプリタを指定すると動きます。この場合、`#!/bin/bash`を書かなくても動きます。

以下を`fruits2.bash`として保存します。今度はchmodはしないでおきます。

```{bash}
FRUITS="mikan ringo budou"

for DESSERT in $FRUITS;do
  echo $DESSERT
done
```

上の例で、`$FRUITS;do`の`;`は命令文の区切りを示し、改行と同じ意味になります。

インタプリタをbashに指定して実行してみましょう。

```{bash}
bash ./fruits2.bash
```

（実行例は略）

## 3. if文

`if ~ then ~ else`を使うと条件によって処理を分岐させることができます。

1から10までの整数を順に表示し、3の倍数のときは数字のかわりに**fizz**と表示するスクリプトを作ってみましょう。FizzBuzzといわれる数字遊びの簡易版です。

以下のスクリプトを`fizz.bash`として保存します。

```{bash}
#!/bin/bash

n=$(seq 10)

for i in $n;do

  if [ $(($i%3)) -eq 0 ];then
    echo "fizz"

  else
    echo $i

  fi
done
```

`if [ 条件式 ];then A else B` で条件式を満たすときに処理Aを行い、満たさないときは処理Bを行います。

`-eq`はテストコマンド`[` のオプションで、`-eq`の後の数値と等しいことを示します。

`seq 数値`で設定数値まで1ずつ増加させた整数を表示します。

`$(($i%3))`はbashの算術式展開です。`$((数式))`で計算した値を求めることができます。`A%B`はAをBで割ったときの余り（剰余）を示します。

では、`chmod`で実行権限をつけてから実行しましょう。

```{bash}
chmod 750 fizz.bash
./fizz.bash
```

（実行例は略）

## 4. while文

`while`を使うと、設定した条件に達するまで、同じ処理を繰り返すことができます。

羊を10匹まで数えて出力するスクリプトを作ってみましょう。

以下を`sheep.bash`という名前で保存します。

```{bash}
#!/bin/bash

n=1

while [ $n -le 10 ];do
  echo "羊が${n}匹"
  n=$((n+1))
  sleep 1
done
```

`while [ 条件式 ]`で、条件式を満たすところまで、`do~done`の間の処理を続けることができます。

`-le` はテストコマンド`[` のオプションで、`-le`の後の数値以下であることを示します。`less than or equal`の略と考えるとわかりやすい（？）ですね。`[`の後ろと、`]`の前には必ず半角スペースを入れてください。

`羊が${n}匹`の部分で、`羊が$n匹`と変数nに{}をつけていないと、正しく値を読み出してくれないので注意してください。

`$((n+1))`は算術式展開と呼ばれるbashの機能です。`n=$((n+1))`はnに1を足したものを次のnとする、という意味です。

`sleep 数値`で数値で指定した秒数だけ処理を止めておくことができます。

では、`chmod`で実行権限をつけてから実行してみましょう。

```{bash}
chmod 750 sheep.bash
./sheep.bash
```

（実行例は略）
